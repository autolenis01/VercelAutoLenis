name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    name: Install, Validate, and Build
    runs-on: ubuntu-latest
    env:
      PRISMA_CHECKPOINT_DISABLE: "1"
      PRISMA_DISABLE_TELEMETRY: "1"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          # Prisma generate runs in postinstall with placeholder URL fallback
          POSTGRES_PRISMA_URL: ""

      - name: Verify Prisma schema is valid
        run: |
          echo "Validating Prisma schema..."
          pnpm prisma validate
        env:
          POSTGRES_PRISMA_URL: "******localhost:5432/placeholder?schema=public"

      - name: Build application
        run: pnpm build
        env:
          # Prisma generate already ran in postinstall
          POSTGRES_PRISMA_URL: ""

      - name: Verify security patches
        run: |
          echo "Verifying happy-dom version..."
          HAPPY_DOM_VERSION=$(pnpm list happy-dom --json | jq -r '.[0].devDependencies["happy-dom"].version')
          echo "happy-dom version: $HAPPY_DOM_VERSION"
          
          # Check if version is >= 20.0.0
          if [ "$(printf '%s\n' "20.0.0" "$HAPPY_DOM_VERSION" | sort -V | head -n1)" = "20.0.0" ]; then
            echo "✓ happy-dom is patched (>= 20.0.0)"
          else
            echo "✗ happy-dom version is vulnerable (< 20.0.0)"
            exit 1
          fi
