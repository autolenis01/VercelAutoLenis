name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    name: Install, Validate, and Build
    runs-on: ubuntu-latest
    env:
      PRISMA_CHECKPOINT_DISABLE: "1"
      PRISMA_DISABLE_TELEMETRY: "1"
      # Deterministic Prisma placeholder URL for CI (quoted to avoid YAML parsing edge cases)
      POSTGRES_PRISMA_URL: "postgresql://user:password@localhost:5432/placeholder?schema=public"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack
        run: corepack enable

      - name: Debug Prisma URL protocol (safe)
        run: |
          node -e "const v=process.env.POSTGRES_PRISMA_URL||''; console.log('POSTGRES_PRISMA_URL protocol ok:', /^postgres(ql)?:\\/\\//.test(v));"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify Prisma schema is valid
        run: |
          echo "Validating Prisma schema..."
          pnpm prisma validate

      - name: Build application
        run: pnpm build

      - name: Verify security patches
        run: |
          echo "Verifying happy-dom version..."
          HAPPY_DOM_VERSION=$(pnpm list happy-dom --json | jq -r '.[0].devDependencies["happy-dom"].version')
          echo "happy-dom version: $HAPPY_DOM_VERSION"

          # Check if version is >= 20.0.0
          if [ "$(printf '%s\n' "20.0.0" "$HAPPY_DOM_VERSION" | sort -V | head -n1)" = "20.0.0" ]; then
            echo "✓ happy-dom is patched (>= 20.0.0)"
          else
            echo "✗ happy-dom version is vulnerable (< 20.0.0)"
            exit 1
          fi
